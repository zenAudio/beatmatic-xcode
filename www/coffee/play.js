// Generated by CoffeeScript 1.3.3
(function() {
  var synth,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  synth = (function() {

    synth.prototype.loopTimers = {};

    synth.prototype.swipeSampleLayover = false;

    synth.prototype.swipeVolumeLayover = false;

    synth.prototype.folder = "sounds/";

    synth.prototype.lastSample = false;

    synth.prototype.originalbpm = false;

    synth.prototype.direction = false;

    synth.prototype.lastDistance = 0;

    function synth() {
      this.loopTrack = __bind(this.loopTrack, this);

      this.stopTrack = __bind(this.stopTrack, this);

      this.loopTracks = __bind(this.loopTracks, this);

      this.stopLoop = __bind(this.stopLoop, this);

      this.generateHTML = __bind(this.generateHTML, this);

      this.setup = __bind(this.setup, this);

      var _this = this;
      $("#snext").click(function() {
        return BEATmatic.ui["switch"]("dj");
      });
      $("sback").click(function() {
        _this.stopLoop();
        BEATmatic.ui["switch"]("main");
        return false;
      });
    }

    synth.prototype.delay = function(ms, func) {
      return setTimeout(func, ms);
    };

    synth.prototype.setup = function(data) {
      this.data = {
        "project": "House Beat 1",
        "bpm": 130,
        "tracks": [
          {
            "name": "kick drum",
            "sample": "kick01.wav",
            "icon": "kickdrum.png",
            "score": [100, 0, 0, 0, 0, 0, 0, 100, 100, 0, 0, 0, 0, 0, 0, 0]
          }, {
            "name": "snare drum",
            "sample": "snare01.wav",
            "icon": "snaredrum.png",
            "score": [0, 0, 0, 0, 100, 0, 0, 0, 0, 0, 0, 0, 100, 0, 0, 0]
          }, {
            "name": "hi hat",
            "sample": "hihat01.wav",
            "icon": "hihat.png",
            "score": [0, 0, 100, 0, 0, 0, 100, 0, 0, 0, 100, 0, 0, 0, 100, 0]
          }
        ]
      };
      if (data !== "demo") {
        data = data;
      }
      this.generateHTML();
      return this.loopTracks();
    };

    synth.prototype.generateHTML = function() {
      var html, index, score, track, _i, _j, _len, _len1, _ref, _ref1,
        _this = this;
      html = "<table id=\"hor-minimalist-a\" class=\"fulltable\" summary=\"Matrix\">";
      _ref = this.data.tracks;
      for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
        track = _ref[index];
        html += "<tr>";
        html += "<td class=\"\"><img width=\"50\" height=\"50\" src=\"img/" + track.icon + "\" alt=\"" + track.name + "\"/></td>";
        _ref1 = track.score;
        for (index = _j = 0, _len1 = _ref1.length; _j < _len1; index = ++_j) {
          score = _ref1[index];
          if (score >= 100) {
            score = 100;
          }
          html += "<td class=\"x" + score + " c" + (index + 1) + "\"></td>";
        }
        html += "</tr>";
      }
      html += "</table>";
      $("#matrix").html(html);
      return $("#hor-minimalist-a").swipe({
        click: function(e, target) {
          var cell;
          score = e.target.cellIndex;
          track = e.target.parentNode.rowIndex;
          cell = $($(".c" + score)[track]);
          if (cell.hasClass("x100")) {
            cell.removeClass("x100");
            return _this.data.tracks[track].score[score - 1] = 0;
          } else {
            cell.addClass("x100");
            return _this.data.tracks[track].score[score - 1] = 100;
          }
        },
        swipeStatus: function(e, phase, direction, distance) {
          var i, move, n, newsample, offset, sample;
          if (phase === "cancel" || phase === "end") {
            console.log("****END****");
            _this.direction = false;
            _this.lastDistance = 0;
            if (_this.swipeSampleLayover) {
              $("#swipeSampleLayover").hide();
              _this.swipeSampleLayover = false;
              _this.stopLoop();
              _this.loopTracks();
            }
            if (_this.swipeVolumeLayover) {
              $("#swipeVolumeLayover").hide();
              _this.originalbpm = _this.data.bpm;
              _this.swipeVolumeLayover = false;
            }
            return;
          }
          if (distance <= 5) {
            return;
          }
          if (direction === "up" || direction === "down") {
            if (!_this.direction) {
              _this.direction = "updown";
            }
            if ("updown" !== _this.direction) {
              return;
            }
            if (!_this.swipeSampleLayover) {
              _this.stopLoop();
              _this.swipeSampleLayover = true;
              /*
              
              						if e.pageX
              							x = e.pageX
              						else
              							x = e.touches[0].pageX
              						
              						if e.pageY
              							y = e.pageY
              						else
              							y = e.touches[0].pageY	
              						
              						totalHeight = $("body").height()
              						layoverHeight = $("#swipeSampleLayover").height()
              						offset = 0
              						
              						
              						if y < layoverHeight/2
              							#console.log "<"
              							offset = layoverHeight/2 - y
              							#x = layoverHeight/2
              						
              						#console.log "totalHeight - y < layoverHeight/2 : #{totalHeight - y} < #{layoverHeight/2} #{totalHeight - y < layoverHeight/2}"
              						
              						if totalHeight - y < layoverHeight/2
              							#console.log ">"
              							offset = totalHeight - y - layoverHeight/2
              						
              						
              						#console.log offset
              						$("#swipeSampleLayover").css "top", y + offset - layoverHeight/2
              						#console.log e.touches
              						#console.log e
              						$("#swipeSampleLayover").css "left", x - 10
              						#$("#swipeSampleLayover").css "left", 15
              */

              $("#swipeSampleLayover").show();
              _this.samplebase = false;
            }
            move = distance - _this.lastDistance;
            console.log("***");
            console.log(distance);
            console.log(_this.lastDistance);
            console.log(move);
            console.log("***");
            if ((move < 10) && (move > -10)) {
              console.log("did not move enough");
              console.log(move);
              return;
            }
            _this.lastDistance = distance;
            track = e.target.parentNode.rowIndex;
            sample = _this.data.tracks[track].sample;
            i = sample.indexOf("0");
            n = Number(sample[i + 1]);
            if (!_this.samplebase) {
              _this.samplebase = sample.slice(0, i);
            }
            if (direction === "up") {
              if (!(n >= 7)) {
                n++;
              }
            }
            if (direction === "down") {
              if (!(n <= 1)) {
                n--;
              }
            }
            newsample = _this.samplebase + 0 + n + sample.slice(i + 2);
            _this.playAudio(_this.folder + newsample);
            _this.data.tracks[track].sample = newsample;
            $("#swipeSampleLayover").html(newsample);
          }
          if (direction === "left" || direction === "right") {
            if (!_this.direction) {
              _this.direction = "leftright";
            }
            if ("leftright" !== _this.direction) {
              return;
            }
            if (!_this.swipeVolumeLayover) {
              $("#swipeVolumeLayover").show();
              _this.swipeVolumeLayover = true;
            }
            offset = Math.round(distance / 2);
            if (direction === "left") {
              offset = offset * -1;
            }
            $("#swipeVolumeLayover").html("" + (_this.data.bpm + offset) + " BPM");
            if (!_this.originalbpm) {
              _this.originalbpm = _this.data.bpm;
            }
            _this.data.bpm = _this.originalbpm + offset;
            _this.stopLoop();
            _this.loopTracks();
          }
        },
        allowPageScroll: "none",
        threshold: 50
      });
      /*
      		
      		$("#hor-minimalist-a").click (e) =>
      			#console.log e
      			#console.log e.target.parentNode.rowIndex
      			#console.log e.target.cellIndex
      			
      			score = e.target.cellIndex
      			track = e.target.parentNode.rowIndex
      			cell = $($(".c#{score}")[track])
      			if cell.hasClass "x100"
      				cell.removeClass "x100"
      				@data.tracks[track].score[score - 1] = 0
      			else
      				cell.addClass "x100"
      				@data.tracks[track].score[score - 1] = 100
      */

    };

    synth.prototype.score = function(track, score) {
      if (this.data.tracks[track].score[score - 1] >= 100) {
        return this.playAudio(this.folder + this.data.tracks[track].sample);
      }
    };

    synth.prototype.highlightColumun = function(col) {
      $(".c" + col).addClass("highlighted");
      col = col - 1;
      if (col === 0) {
        col = 16;
      }
      return $(".c" + col).removeClass("highlighted");
    };

    synth.prototype.stopLoop = function() {
      var loopTimer, track, _ref;
      _ref = this.loopTimers;
      for (track in _ref) {
        loopTimer = _ref[track];
        clearInterval(loopTimer);
        loopTimer = null;
      }
      return $(".highlighted").removeClass("highlighted");
    };

    synth.prototype.loopTracks = function() {
      this.loopTrack(0);
      this.loopTrack(1);
      return this.loopTrack(2);
    };

    synth.prototype.stopTrack = function(track) {
      return clearInterval(this.loopTimers[track]);
    };

    synth.prototype.loopTrack = function(track) {
      var loopvar, ms,
        _this = this;
      loopvar = 0;
      ms = 15000 / this.data.bpm;
      ms = ms.toFixed(0);
      return this.loopTimers[track] = setInterval(function() {
        loopvar = loopvar + 1;
        _this.highlightColumun(loopvar);
        _this.score(track, loopvar);
        if (loopvar === 16) {
          return loopvar = 0;
        }
      }, ms);
    };

    synth.prototype.playAudio = function(src) {
      var my_media;
      if (typeof Media !== "undefined" && Media !== null) {
        my_media = new Media(src, this.onSuccess, this.onError, this.onStatus);
        return my_media.play();
      } else {

      }
    };

    synth.prototype.onSuccess = function() {};

    synth.prototype.onStatus = function(status) {};

    synth.prototype.onError = function(error) {
      return alert("code: " + error.code + "\n" + "message: " + error.message + "\n");
    };

    return synth;

  })();

  $(function() {
    return BEATmatic.synth = new synth();
  });

}).call(this);
